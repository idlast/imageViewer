# Feature Specification: タブ付き画像ビューア

**Feature Branch**: `001-tabbed-image-viewer`  
**Created**: 2025-12-03  
**Status**: Draft  
**Input**: User description: "タブ機能を持った画像表示アプリケーション。常に最前表示オプション、ウィンドウサイズに合わせた画像表示、Ctrl+ホイールで拡大縮小"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 画像ファイルを開いて表示する (Priority: P1)

ユーザーは画像ファイルを開いて、ウィンドウ内に適切なサイズで表示できる。画像はウィンドウサイズに収まるように自動的にスケーリングされる。

**Why this priority**: 画像ビューアの最も基本的な機能であり、これなしでは他の機能が成り立たない

**Independent Test**: 任意の画像ファイルをドラッグ＆ドロップまたはメニューから開き、画像が表示されることを確認する

**Acceptance Scenarios**:

1. **Given** アプリケーションが起動している, **When** ユーザーがファイルメニューから画像を開く, **Then** 画像がウィンドウ内に収まるサイズで表示される
2. **Given** 画像が表示されている, **When** ウィンドウサイズを変更する, **Then** 画像はウィンドウに収まるように自動的にリサイズされる
3. **Given** アプリケーションが起動している, **When** ユーザーが画像ファイルをウィンドウにドラッグ＆ドロップする, **Then** 画像が新しいタブで表示される

---

### User Story 2 - 複数画像をタブで管理する (Priority: P1)

ユーザーは複数の画像を同時に開き、タブで切り替えながら閲覧できる。Windows 11のメモ帳と同様のタブUIを持つ。

**Why this priority**: タブ機能はこのビューアの核心的な差別化要素であり、P1として基本表示と同時に実装すべき

**Independent Test**: 複数の画像を開き、タブをクリックして画像を切り替えられることを確認する

**Acceptance Scenarios**:

1. **Given** 1つの画像がタブで開かれている, **When** 新しい画像を開く, **Then** 新しいタブが作成され、そのタブがアクティブになる
2. **Given** 複数のタブが開かれている, **When** タブをクリックする, **Then** 対応する画像が表示される
3. **Given** 複数のタブが開かれている, **When** タブの閉じるボタン（×）をクリックする, **Then** そのタブが閉じられ、隣のタブがアクティブになる
4. **Given** 最後のタブが開かれている, **When** そのタブを閉じる, **Then** 空のウィンドウ状態になる（アプリは終了しない）

---

### User Story 3 - 画像の拡大・縮小 (Priority: P2)

ユーザーはCtrl+マウスホイールで画像を拡大・縮小できる。ただし、ウィンドウサイズを変更した場合は自動フィットが優先される。

**Why this priority**: 画像の詳細確認に必要な機能だが、基本表示とタブ機能が先に必要

**Independent Test**: 画像を開き、Ctrl+ホイールで拡大縮小後、ウィンドウサイズ変更で自動フィットに戻ることを確認する

**Acceptance Scenarios**:

1. **Given** 画像が表示されている, **When** Ctrl+ホイール上回転する, **Then** 画像が拡大される
2. **Given** 画像が表示されている, **When** Ctrl+ホイール下回転する, **Then** 画像が縮小される
3. **Given** 画像が拡大された状態, **When** ウィンドウサイズを変更する, **Then** 画像はウィンドウに収まるサイズに自動フィットされる（拡大状態はリセット）
4. **Given** 画像が拡大された状態, **When** 画像がウィンドウより大きい場合, **Then** スクロールバーが表示され、スクロールで全体を閲覧できる

---

### User Story 4 - 常に最前面表示 (Priority: P3)

ユーザーはメニューから「常に最前面に表示」を選択し、ウィンドウを他のウィンドウより前に固定できる。

**Why this priority**: 便利機能であり、コア機能の実装後に追加可能

**Independent Test**: メニューから設定を切り替え、他のウィンドウをクリックしてもビューアが前面に留まることを確認する

**Acceptance Scenarios**:

1. **Given** アプリケーションが通常表示されている, **When** メニューから「常に最前面に表示」を選択する, **Then** ウィンドウが最前面に固定され、メニュー項目にチェックマークが付く
2. **Given** 最前面表示が有効, **When** 他のアプリケーションをクリックする, **Then** ビューアは前面に留まる
3. **Given** 最前面表示が有効, **When** 再度「常に最前面に表示」を選択する, **Then** 最前面表示が解除され、チェックマークが消える

---

### User Story 5 - セッション復元 (Priority: P2)

アプリケーション終了時の状態（ウィンドウサイズ・位置、開いていたタブ、アクティブだったタブ）を記憶し、次回起動時に復元する。

**Why this priority**: ユーザー体験を大きく向上させる機能であり、タブ機能と密接に関連するため早期に実装すべき

**Independent Test**: 複数タブを開いてウィンドウサイズを変更し、アプリを終了→再起動して状態が復元されることを確認する

**Acceptance Scenarios**:

1. **Given** 複数のタブが開かれている状態でアプリを終了した, **When** 次回アプリを起動する, **Then** 前回開いていたすべてのタブが復元される
2. **Given** 特定のタブがアクティブな状態でアプリを終了した, **When** 次回アプリを起動する, **Then** 前回アクティブだったタブがアクティブな状態で復元される
3. **Given** ウィンドウサイズを変更してアプリを終了した, **When** 次回アプリを起動する, **Then** 前回のウィンドウサイズと位置が復元される
4. **Given** 前回開いていた画像ファイルが削除されている, **When** アプリを起動する, **Then** 存在するファイルのタブのみ復元され、削除されたファイルは無視される
5. **Given** 初回起動（セッション情報なし）, **When** アプリを起動する, **Then** デフォルトのウィンドウサイズで空の状態で起動する

---

### User Story 6 - タブ右クリックメニュー (Priority: P2)

ユーザーはタブを右クリックして、そのタブや他のタブを効率的に閉じるためのコンテキストメニューを利用できる。

**Why this priority**: タブ管理の利便性向上機能であり、基本タブ機能が完成した後に追加すべき

**Independent Test**: タブを右クリックしてメニューが表示され、各メニュー項目が正しく動作することを確認する

**Acceptance Scenarios**:

1. **Given** タブが開かれている, **When** タブを右クリックする, **Then** コンテキストメニューが表示される
2. **Given** コンテキストメニューが表示されている, **When** 「タブを閉じる」をクリックする, **Then** 右クリックしたタブが閉じられる
3. **Given** 複数のタブが開かれている, **When** 「右側のタブをすべて閉じる」をクリックする, **Then** 右クリックしたタブより右にあるタブがすべて閉じられる
4. **Given** 複数のタブが開かれている, **When** 「ほかのタブをすべて閉じる」をクリックする, **Then** 右クリックしたタブ以外のタブがすべて閉じられる
5. **Given** 右クリックしたタブが最右端, **When** コンテキストメニューを表示する, **Then** 「右側のタブをすべて閉じる」は無効化（グレーアウト）される
6. **Given** タブが1つだけ開かれている, **When** コンテキストメニューを表示する, **Then** 「ほかのタブをすべて閉じる」は無効化される

---

### User Story 7 - 画像拡大時のドラッグスクロール (Priority: P2)

ユーザーは拡大した画像をマウスドラッグで直感的にスクロールできる。スクロールバーは表示せず、ドラッグ操作のみでナビゲーションする。

**Why this priority**: ズーム機能の利便性向上であり、基本ズーム機能が完成した後に追加すべき

**Independent Test**: 画像を拡大し、左クリックしながらドラッグして画像がスクロールすることを確認する

**Acceptance Scenarios**:

1. **Given** 画像が拡大されている, **When** ユーザーが画像上で左クリックを押したままドラッグする, **Then** 画像がドラッグ方向と逆方向にスクロールする（手で紙を動かすような操作感）
2. **Given** 画像が拡大されている, **When** ユーザーがドラッグする, **Then** スクロールバーは表示されない
3. **Given** 画像が拡大されていない（フィット表示）, **When** ユーザーがドラッグする, **Then** 何も起こらない（フィット時はスクロール不要）
4. **Given** 画像をドラッグ中, **When** マウスボタンを離す, **Then** スクロールが停止し現在位置が維持される
5. **Given** 画像が拡大されている, **When** ドラッグする, **Then** カーソルが「掴む」アイコン（Hand）に変化する

---

### Edge Cases

- 破損した画像ファイルを開こうとした場合、エラーメッセージを表示し、アプリはクラッシュしない
- 非常に大きな画像（10000x10000px以上）を開いた場合でも、メモリを適切に管理して表示する
- サポート対象外のファイル形式を開こうとした場合、適切なエラーメッセージを表示する
- 開いている画像ファイルが外部で削除された場合、適切に処理する
- タブを大量（20個以上）開いた場合でも、タブバーが適切にスクロールまたは縮小表示される
- セッション復元時に画像ファイルが移動・名前変更されていた場合、そのタブは復元されない
- セッションデータが破損している場合、デフォルト状態で起動する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: アプリケーションはタブインターフェースで複数の画像を同時に開けること
- **FR-002**: 各タブはファイル名をタブタイトルとして表示すること
- **FR-003**: 画像はウィンドウサイズに収まるように自動的にスケーリングされること
- **FR-004**: ユーザーはCtrl+マウスホイールで画像を拡大・縮小できること
- **FR-005**: ウィンドウサイズ変更時は自動フィットが拡大・縮小設定より優先されること
- **FR-006**: メニューバーに「表示」メニューを設け、「常に最前面に表示」オプションを提供すること
- **FR-007**: 「常に最前面に表示」はトグル式で、現在の状態がチェックマークで示されること
- **FR-008**: 画像ファイルをウィンドウにドラッグ＆ドロップして開けること
- **FR-009**: ファイルメニューから「開く」で画像を選択できること
- **FR-010**: サポート対象フォーマット: JPEG, PNG, GIF, BMP, TIFF, WebP, HEIC
- **FR-011**: アプリケーション終了時にセッション情報（開いているタブ、アクティブタブ、ウィンドウサイズ・位置）を保存すること
- **FR-012**: アプリケーション起動時に前回のセッション情報を読み込み、状態を復元すること
- **FR-013**: セッション復元時、存在しないファイルのタブはスキップすること
- **FR-014**: タブを右クリックするとコンテキストメニュー（「タブを閉じる」「右側のタブをすべて閉じる」「ほかのタブをすべて閉じる」）が表示されること
- **FR-015**: 画像拡大時はスクロールバーを非表示とし、左クリック＋ドラッグで画像をスクロールできること
- **FR-016**: ドラッグスクロールはドラッグ方向と逆方向に画像が移動すること（手で紙を動かす操作感）

### Key Entities

- **ImageTab**: 1つのタブを表す。ファイルパス、表示中の画像データ、ズーム状態を保持
- **ViewerWindow**: メインウィンドウ。タブコレクション、最前面表示状態、ウィンドウサイズを管理
- **SessionData**: セッション情報。ウィンドウサイズ・位置、開いているタブのファイルパス一覧、アクティブタブのインデックスを保持

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは画像を開いてから100ms以内に表示を確認できる（中サイズ画像の場合）
- **SC-002**: タブの切り替えは50ms以内に完了する
- **SC-003**: 10枚以上の画像をタブで開いた状態でもスムーズに操作できる
- **SC-004**: ウィンドウリサイズ中も画像表示がカクつかない
- **SC-005**: Ctrl+ホイール操作に対して即座に視覚的フィードバックがある
- **SC-006**: アプリケーション再起動後、前回のセッション状態が正確に復元される
- **SC-007**: セッション復元は起動から500ms以内に完了する（10タブ程度の場合）

## Assumptions

- ユーザーはWindowsの標準的な操作（ドラッグ＆ドロップ、右クリックメニュー等）に慣れている
- 主な用途は画像の閲覧であり、編集機能は含まない
- タブの並べ替え（ドラッグによる順序変更）は初期スコープには含まない
- 最前面表示状態はセッションには保存しない（起動時は常にオフ）
- セッションデータの保存場所はユーザーのAppDataフォルダを想定
