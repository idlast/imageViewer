<Window x:Class="ImgViewer.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ImgViewer"
        xmlns:views="clr-namespace:ImgViewer.Views"
        xmlns:vm="clr-namespace:ImgViewer.ViewModels"
        mc:Ignorable="d"
        Title="ImgViewer"
        Width="{Binding WindowWidth, Mode=TwoWay}"
        Height="{Binding WindowHeight, Mode=TwoWay}"
        Left="{Binding WindowLeft, Mode=TwoWay}"
        Top="{Binding WindowTop, Mode=TwoWay}"
        Topmost="{Binding IsAlwaysOnTop}"
        AllowDrop="True"
        Drop="OnDrop"
        DragOver="OnDragOver"
        Closing="OnClosing"
        SizeChanged="OnSizeChanged"
        Background="{StaticResource WindowBackgroundBrush}">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- メニューバー -->
        <Menu Grid.Row="0">
            <MenuItem Header="ファイル(_F)">
                <MenuItem Header="開く(_O)" Command="{Binding OpenFileCommand}" InputGestureText="Ctrl+O"/>
                <Separator/>
                <MenuItem Header="終了(_X)" Click="OnExitClick"/>
            </MenuItem>
            <MenuItem Header="表示(_V)">
                <MenuItem Header="常に最前面に表示(_T)"
                          IsCheckable="True"
                          IsChecked="{Binding IsAlwaysOnTop, Mode=TwoWay}"/>
                <Separator/>
                <MenuItem Header="拡大(_I)" Command="{Binding ZoomInCommand}" InputGestureText="Ctrl++"/>
                <MenuItem Header="縮小(_O)" Command="{Binding ZoomOutCommand}" InputGestureText="Ctrl+-"/>
                <MenuItem Header="ズームをリセット(_R)" Command="{Binding ResetZoomCommand}" InputGestureText="Ctrl+0"/>
                <Separator/>
                <MenuItem Header="ズーム刻み(_S)">
                    <MenuItem Header="4% (細かい)"
                              IsCheckable="True"
                              IsChecked="{Binding ZoomStepPercent, Converter={StaticResource EqualsConverter}, ConverterParameter=4}"
                              Command="{Binding SetZoomStepCommand}"
                              CommandParameter="4"/>
                    <MenuItem Header="10% (標準)"
                              IsCheckable="True"
                              IsChecked="{Binding ZoomStepPercent, Converter={StaticResource EqualsConverter}, ConverterParameter=10}"
                              Command="{Binding SetZoomStepCommand}"
                              CommandParameter="10"/>
                    <MenuItem Header="20% (素早い)"
                              IsCheckable="True"
                              IsChecked="{Binding ZoomStepPercent, Converter={StaticResource EqualsConverter}, ConverterParameter=20}"
                              Command="{Binding SetZoomStepCommand}"
                              CommandParameter="20"/>
                </MenuItem>
            </MenuItem>
        </Menu>

        <!-- タブコントロール -->
        <TabControl Grid.Row="1"
                    ItemsSource="{Binding Tabs}"
                    SelectedItem="{Binding SelectedTab}"
                    TabStripPlacement="Top"
                    Background="Transparent"
                    BorderThickness="0">
            <TabControl.Resources>
                <Style TargetType="TabPanel">
                    <Setter Property="HorizontalAlignment" Value="Left"/>
                    <Setter Property="Background" Value="Transparent"/>
                </Style>
            </TabControl.Resources>
            <TabControl.ItemContainerStyle>
                <Style TargetType="TabItem" BasedOn="{StaticResource {x:Type TabItem}}">
                    <Setter Property="Tag" Value="{Binding DataContext, RelativeSource={RelativeSource AncestorType=TabControl}}"/>
                    <Setter Property="ContextMenu">
                        <Setter.Value>
                            <ContextMenu>
                                <MenuItem Header="タブを閉じる"
                                          Command="{Binding PlacementTarget.Tag.CloseTabCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                <MenuItem Header="右側のタブをすべて閉じる"
                                          Command="{Binding PlacementTarget.Tag.CloseTabsToTheRightCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                                <MenuItem Header="ほかのタブをすべて閉じる"
                                          Command="{Binding PlacementTarget.Tag.CloseOtherTabsCommand, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                                          CommandParameter="{Binding PlacementTarget.DataContext, RelativeSource={RelativeSource AncestorType=ContextMenu}}"/>
                            </ContextMenu>
                        </Setter.Value>
                    </Setter>
                </Style>
            </TabControl.ItemContainerStyle>
            <TabControl.Template>
                <ControlTemplate TargetType="TabControl">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <!-- タブヘッダーエリアの背景 -->
                        <Border Grid.Row="0" Background="{StaticResource ControlBackgroundBrush}" Padding="0,8,0,0">
                            <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                          VerticalScrollBarVisibility="Disabled"
                                          Background="Transparent">
                                <TabPanel IsItemsHost="True"/>
                            </ScrollViewer>
                        </Border>
                        <ContentPresenter Grid.Row="1"
                                          ContentSource="SelectedContent"/>
                    </Grid>
                </ControlTemplate>
            </TabControl.Template>
            <TabControl.ItemTemplate>
                <DataTemplate DataType="{x:Type vm:ImageTabViewModel}">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="{Binding FileName}" VerticalAlignment="Center"/>
                        <Button Style="{StaticResource TabCloseButtonStyle}"
                                Command="{Binding DataContext.CloseTabCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                CommandParameter="{Binding}"/>
                    </StackPanel>
                </DataTemplate>
            </TabControl.ItemTemplate>
            <TabControl.ContentTemplate>
                <DataTemplate DataType="{x:Type vm:ImageTabViewModel}">
                    <views:ImageTabView/>
                </DataTemplate>
            </TabControl.ContentTemplate>
        </TabControl>

        <!-- タブがない時の表示 -->
        <TextBlock Grid.Row="1"
                   Text="画像ファイルをドラッグ＆ドロップ、または「ファイル」→「開く」で画像を開いてください"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   FontSize="16"
                   Foreground="{StaticResource TextSecondaryBrush}"
                   Visibility="{Binding SelectedTab, Converter={StaticResource InverseNullToVisibility}}"/>
    </Grid>
</Window>
